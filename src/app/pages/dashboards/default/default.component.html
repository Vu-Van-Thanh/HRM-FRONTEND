<app-loader></app-loader>
<div class="container-fluid">
    <!-- start page title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0 font-size-18">Dashboard</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <ng-container>
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a>
                            </li>
                            <li class="breadcrumb-item active">Dashboard
                            </li>
                        </ng-container>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <!-- end page title -->

    <!-- Quick Action Cards and Quick access icons in a single row -->
    <div class="row mb-4">
        <!-- Quick Action Cards Column -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center p-1 border rounded bg-light-subtle" style="height: 48px;">
                                <span class="avatar-title rounded-circle bg-primary-subtle text-primary me-2" style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bx bx-calendar font-size-14"></i>
                                </span>
                                <span class="font-size-12">Xin nghỉ phép</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center p-1 border rounded bg-light-subtle" style="height: 48px;">
                                <span class="avatar-title rounded-circle bg-danger-subtle text-danger me-2" style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bx bx-user-plus font-size-14"></i>
                                </span>
                                <span class="font-size-12">Thêm tăng ca</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center p-1 border rounded bg-light-subtle" style="height: 48px;">
                                <span class="avatar-title rounded-circle bg-warning-subtle text-warning me-2" style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bx bx-time font-size-14"></i>
                                </span>
                                <span class="font-size-12">Quên chấm công</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-1 border rounded bg-light-subtle" style="height: 48px;">
                                <span class="avatar-title rounded-circle bg-success-subtle text-success me-2" style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="bx bx-briefcase font-size-14"></i>
                                </span>
                                <span class="font-size-12">Đi công tác</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick access icons Column -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-file text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">Công</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-id-card text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">Hồ sơ cá nhân</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-check-square text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">DS quên chấm công</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-calendar-check text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">DS ngày nghỉ</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-time-five text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">DS tăng ca</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="avatar-md mx-auto mb-2 rounded-circle bg-light-subtle">
                                    <span class="avatar-title rounded-circle bg-light font-size-24">
                                        <i class="bx bx-dots-horizontal-rounded text-primary"></i>
                                    </span>
                                </div>
                                <p class="mb-0 font-size-13">Xem thêm</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Sections -->
    <div class="row mb-4">
        <!-- Personal Schedule Section -->
        <div class="col-xl-4 mb-4">
            <div class="card" style="height: 450px;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Lịch Cá Nhân</h4>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-light me-2" (click)="previousWeek()">
                                <i class="bx bx-chevron-left"></i>
                            </button>
                            <span class="text-muted small">
                                {{ formatDate(weekStartDate) }} - {{ formatDate(weekEndDate) }}
                            </span>
                            <button class="btn btn-sm btn-light ms-2" (click)="nextWeek()">
                                <i class="bx bx-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Days -->
                    <div class="d-flex gap-2 mb-3 justify-content-between">
                        <ng-container *ngFor="let i of [0, 1, 2, 3, 4, 5, 6]">
                            <div class="text-center p-2 rounded cursor-pointer" 
                                 [ngClass]="getWeekdayStatusClass(i)"
                                 (click)="selectWeekday(i)">
                                <div class="text-muted small">{{ ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][i] }}</div>
                                <div class="font-size-16 fw-bold">
                                    {{ getWeekdayDate(i) }}
                                </div>
                            </div>
                        </ng-container>
                    </div>

                    <!-- Schedule Items -->
                    <div class="schedule-items">
                        <ng-container *ngIf="filteredActivities && filteredActivities.length > 0; else noActivities">
                            <div class="card mb-2 bg-light" *ngFor="let activity of filteredActivities">
                                <div class="card-body py-2 px-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-1 fs-6">{{ getActivityInRequestFlds(activity.requestFlds) }}</h6>
                                        <span class="badge" [ngClass]="{'bg-success': activity.status === 'APPROVED', 
                                                               'bg-warning': activity.status === 'PENDING', 
                                                               'bg-danger': activity.status === 'REJECTED'}">
                                            {{ activity.status }}
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-1">ID: {{ activity.activityId }}</p>
                                    <p class="text-muted small mb-0" *ngIf="activity.startTime">
                                        {{ activity.startTime | date:'dd/MM/yyyy HH:mm' }}
                                        <ng-container *ngIf="activity.endTime">
                                            - {{ activity.endTime | date:'dd/MM/yyyy HH:mm' }}
                                        </ng-container>
                                    </p>
                                </div>
                            </div>
                        </ng-container>
                        <ng-template #noActivities>
                            <div class="alert alert-info py-2">
                                <ng-container *ngIf="selectedWeekday !== null; else allDaysMessage">
                                    Không có hoạt động nào vào ngày này
                                </ng-container>
                                <ng-template #allDaysMessage>
                                    Không có hoạt động nào trong tuần này
                                </ng-template>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Progress Section -->
        <div class="col-xl-4 mb-4">
            <div class="card" style="height: 450px;">
                <div class="card-body d-flex flex-column">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Tiến Độ Công Việc</h4>
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle text-muted" data-bs-toggle="dropdown">
                                <i class="bx bx-dots-horizontal-rounded"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Task Counters -->
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <h1 class="display-5 mb-0 fw-bold">{{totalTasks}}</h1>
                            <p class="text-muted mb-0">Tổng công việc</p>
                        </div>
                        <div>
                            <h1 class="display-5 mb-0 fw-bold text-primary">{{completedTasks}}</h1>
                            <p class="text-muted mb-0">Hoàn thành</p>
                        </div>
                    </div>
                    
                    <!-- Progress Chart Section - Fixed Layout -->
                    <div class="mb-4">
                        <div style="height: 150px; position: relative;">
                            <apx-chart 
                                dir="ltr" 
                                [series]="workProgressChart.series" 
                                [chart]="workProgressChart.chart"
                                [colors]="workProgressChart.colors"
                                [stroke]="workProgressChart.stroke"
                                [fill]="workProgressChart.fill"
                                [xaxis]="workProgressChart.xaxis"
                                [dataLabels]="workProgressChart.dataLabels">
                            </apx-chart>
                        </div>
                    </div>
                    
                <!-- 
                    <h5 class="mb-3 mt-4">Công việc hiện tại</h5>-->
                    
                    <!-- 
                    <div>
                        <ng-container *ngIf="employeeTasks && employeeTasks.length > 0; else noTasks">
                            <div class="card mb-2 border" *ngFor="let task of employeeTasks | slice:0:6">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fs-6">{{task.title}}</h6>
                                        <span class="badge" 
                                              [ngClass]="{'bg-success': task.status === 'Completed' || task.status === 'Done', 
                                                         'bg-warning': task.status === 'In Progress', 
                                                         'bg-danger': task.status === 'Overdue', 
                                                         'bg-info': task.status === 'To Do'}">
                                            {{task.status}}
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-1">{{task.projectName}}</p>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted small">
                                            <i class="bx bx-calendar me-1"></i>{{task.deadline | date:'dd/MM/yyyy'}}
                                        </span>
                                        <span class="text-muted small">
                                            <i class="bx bx-flag me-1"></i>{{task.priority}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-2 mb-2" *ngIf="employeeTasks.length > 6">
                                <a href="javascript:void(0);" class="btn btn-sm btn-link">Xem tất cả công việc</a>
                            </div>
                        </ng-container>
                        <ng-template #noTasks>
                            <div class="alert alert-info py-2">
                                Không có công việc nào được giao
                            </div>
                        </ng-template>
                    </div>
                    Task List -->
                </div>
            </div>
        </div>

        <!-- My Activities Section with Chart -->
        <div class="col-xl-4 mb-4">
            <div class="card" style="height: 450px;">
                <div class="card-body d-flex flex-column">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Hoạt động của tôi</h4>
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle text-muted" data-bs-toggle="dropdown">
                                <i class="bx bx-dots-horizontal-rounded"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Activity Hours Chart Section - Restructured -->
                    <div class="mb-4">
                        <div style="height: 150px; position: relative;">
                            <apx-chart 
                                dir="ltr" 
                                [series]="activityHoursChart.series" 
                                [chart]="activityHoursChart.chart"
                                [labels]="activityHoursChart.labels"
                                [colors]="activityHoursChart.colors"
                                [legend]="activityHoursChart.legend"
                                [plotOptions]="activityHoursChart.plotOptions"
                                [dataLabels]="activityHoursChart.dataLabels">
                            </apx-chart>

                            <!-- Center text positioned absolutely -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
                                <h4 class="mb-0">{{ totalActivityHours }}</h4>
                                <p class="text-muted small mb-0">Tổng giờ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend Section -->
                    <div class="mb-2">
                        <div class="d-flex align-items-center mb-1" *ngFor="let stat of activityStats; let i = index">
                            <span class="badge rounded-circle me-2" [ngStyle]="{'background-color': activityHoursChart.colors[i % activityHoursChart.colors.length]}">&nbsp;</span>
                            <span class="small">{{ stat.type }}</span>
                            <span class="ms-auto small">{{ stat.hours.toFixed(1) }}h ({{ stat.percentage.toFixed(1) }}%)</span>
                        </div>
                    </div>
                    
                    <!--
                    <h5 class="mb-2">Danh sách hoạt động</h5>
                    <div>
                        <ng-container *ngIf="employeeActivities && employeeActivities.length > 0; else noEmployeeActivities">
                            <div class="card mb-2 bg-light" *ngFor="let activity of employeeActivities | slice:0:6">
                                <div class="card-body py-1 px-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-1 fs-6">{{ getActivityInRequestFlds(activity.requestFlds) }}</h6>
                                        <span class="badge" [ngClass]="{'bg-success': activity.status === 'APPROVED', 
                                                               'bg-warning': activity.status === 'PENDING', 
                                                               'bg-danger': activity.status === 'REJECTED'}">
                                            {{ activity.status }}
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-0" *ngIf="activity.startTime">
                                        {{ activity.startTime | date:'dd/MM/yyyy HH:mm' }}
                                        <ng-container *ngIf="activity.endTime">
                                            - {{ activity.endTime | date:'dd/MM/yyyy HH:mm' }}
                                        </ng-container>
                                    </p>
                                </div>
                            </div>
                            <div class="text-center mt-2 mb-2" *ngIf="employeeActivities.length > 6">
                                <a href="javascript:void(0);" class="btn btn-sm btn-link">Xem tất cả hoạt động</a>
                            </div>
                        </ng-container>
                        <ng-template #noEmployeeActivities>
                            <div class="alert alert-info py-2">
                                Không có hoạt động nào
                            </div>
                        </ng-template>
                    </div>
                     Activities List Section -->
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Calendar Section and Internal News in one row -->
    <div class="row">
        <!-- Calendar Section -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <h4 class="card-title mb-0 me-3">LỊCH CHẤM CÔNG - KỲ CÔNG THÁNG</h4>
                            <div class="d-flex align-items-center ms-3">
                                <select class="form-select form-select-sm me-2" style="width: auto;" [(ngModel)]="selectedMonth" (change)="updateCalendar()">
                                    <option [value]="0" [selected]="selectedMonth === 0">Tháng 1</option>
                                    <option [value]="1" [selected]="selectedMonth === 1">Tháng 2</option>
                                    <option [value]="2" [selected]="selectedMonth === 2">Tháng 3</option>
                                    <option [value]="3" [selected]="selectedMonth === 3">Tháng 4</option>
                                    <option [value]="4" [selected]="selectedMonth === 4">Tháng 5</option>
                                    <option [value]="5" [selected]="selectedMonth === 5">Tháng 6</option>
                                    <option [value]="6" [selected]="selectedMonth === 6">Tháng 7</option>
                                    <option [value]="7" [selected]="selectedMonth === 7">Tháng 8</option>
                                    <option [value]="8" [selected]="selectedMonth === 8">Tháng 9</option>
                                    <option [value]="9" [selected]="selectedMonth === 9">Tháng 10</option>
                                    <option [value]="10" [selected]="selectedMonth === 10">Tháng 11</option>
                                    <option [value]="11" [selected]="selectedMonth === 11">Tháng 12</option>
                                </select>
                                <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="selectedYear" (change)="updateCalendar()">
                                    <option [value]="selectedYear - 2" [selected]="selectedYear === selectedYear - 2">{{selectedYear - 2}}</option>
                                    <option [value]="selectedYear - 1" [selected]="selectedYear === selectedYear - 1">{{selectedYear - 1}}</option>
                                    <option [value]="selectedYear" [selected]="true">{{selectedYear}}</option>
                                    <option [value]="selectedYear + 1" [selected]="selectedYear === selectedYear + 1">{{selectedYear + 1}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <label class="form-check-label me-3" for="flexSwitchCheckDefault">Xem giờ</label>
                            <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                        </div>
                    </div>
                    
                    <!-- Calendar Legend -->
                    <div class="d-flex mb-3 flex-wrap">
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-danger me-2">&nbsp;</span>
                            <small>Tăng ca</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-primary me-2">&nbsp;</span>
                            <small>Vắng mặt</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-success me-2">&nbsp;</span>
                            <small>Khai công đủ (8h)</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-warning me-2">&nbsp;</span>
                            <small>Chờ phê duyệt</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-danger me-2">&nbsp;</span>
                            <small>Khai công thiếu</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-secondary me-2">&nbsp;</span>
                            <small>Chưa khai</small>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2">
                            <span class="badge rounded-circle bg-info me-2">&nbsp;</span>
                            <small>Nghỉ lễ</small>
                        </div>
                    </div>
                    
                    <!-- Calendar Week Days -->
                    <div class="row mb-2 text-center">
                        <div class="col">Chủ nhật</div>
                        <div class="col">Thứ 2</div>
                        <div class="col">Thứ 3</div>
                        <div class="col">Thứ 4</div>
                        <div class="col">Thứ 5</div>
                        <div class="col">Thứ 6</div>
                        <div class="col">Thứ 7</div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="calendar-grid">
                        <!-- Calendar rows will be generated dynamically based on selected month/year -->
                        <ng-container *ngIf="calendarWeeks && calendarWeeks.length > 0">
                            <div class="row g-2 mb-2" *ngFor="let week of calendarWeeks">
                                <div class="col" *ngFor="let day of week">
                                    <div class="p-2 border rounded text-center" [ngClass]="{'bg-light-subtle': !day.isCurrentMonth}">
                                        <h5 *ngIf="day.date">{{day.date}}</h5>
                                        <h5 *ngIf="!day.date">&nbsp;</h5>
                                        <div class="d-flex justify-content-center" *ngIf="day.status">
                                            <span class="badge rounded-circle" [ngClass]="getStatusClass(day.status)">&nbsp;</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internal News Section -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="card-title mb-0">Tin Tức Nội Bộ</h4>
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle text-muted" data-bs-toggle="dropdown">
                                <i class="bx bx-dots-horizontal-rounded"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Birthday Notification -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <img src="assets/images/users/avatar-1.jpg" alt="User Avatar" class="rounded-circle" width="64">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="mb-1">Hôm nay là sinh nhật</div>
                            <h5 class="mb-1">Hoàng Vũ</h5>
                            <button class="btn btn-primary btn-sm">
                                <i class="bx bx-gift me-1"></i> Gửi Lời Chúc
                            </button>
                        </div>
                    </div>
                    
                    <!-- Company News -->
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <img src="assets/images/small/img-1.jpg" alt="News Image" width="64" class="rounded">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Phòng nhân sự</h6>
                            <p class="mb-1">Wellcome đồng nghiệp</p>
                            <p class="text-muted small mb-0">Lorem Ipsum is simply dummy text of the printing and typesetting industry...</p>
                        </div>
                    </div>
                    
                    <!-- Additional News -->
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <img src="assets/images/small/img-2.jpg" alt="News Image" width="64" class="rounded">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Hội chị em cây khế</h6>
                            <p class="mb-1">Thần thơ chuyển công sở</p>
                            <p class="text-muted small mb-0">Lorem Ipsum is simply dummy text of the printing and typesetting industry...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> <!-- container-fluid -->
